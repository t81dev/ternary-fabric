#!/bin/bash
# TFMBS Transparent Interposer Wrapper

if [ "$#" -lt 1 ]; then
    echo "Usage: $0 <command> [args...]"
    echo "Example: $0 ./bin/mock_llama"
    exit 1
fi

# Find the absolute path to the project root
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

# Configure paths
LIB_DIR="$ROOT_DIR/bin"
INTERCEPT_LIB="$LIB_DIR/libtfmbs_intercept.so"

if [ ! -f "$INTERCEPT_LIB" ]; then
    echo "Error: Interposer library not found at $INTERCEPT_LIB"
    echo "Run 'make' first."
    exit 1
fi

# Detect OS for preload variable
UNAME_S=$(uname -s)
if [ "$UNAME_S" == "Darwin" ]; then
    PRELOAD_ENV="DYLD_INSERT_LIBRARIES"
    LIBPATH_ENV="DYLD_LIBRARY_PATH"
else
    PRELOAD_ENV="LD_PRELOAD"
    LIBPATH_ENV="LD_LIBRARY_PATH"
fi

# Set defaults
export FABRIC_SHORT_CIRCUIT=${FABRIC_SHORT_CIRCUIT:-1}

# Execute with interposer
export $LIBPATH_ENV="$LIB_DIR:${!LIBPATH_ENV}"
export $PRELOAD_ENV="$INTERCEPT_LIB"

exec "$@"
